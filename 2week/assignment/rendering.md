## 렌더러 프로세스의 작업

네트워크 프로세스 = 자원 요청 = {IN 렌더링엔진 HTML파싱/CSS파싱 = 렌더트리 생성 = 레이아웃 = 페인트 = 합성}

---

#### 1. 파싱

일련의 문자열을 의미있는 토큰으로 분해하고 토큰간의 위계관계를 분석해 구조를 결정하는 것. 주로 트리형태로 결과를 표현하는데 이 트리는 parse 트리, parsing 트리, concrete syntax 트리 등으로 부름.

1.  변환: 문서를 가져와 지정된 인코딩 방식으로 읽음
2.  토큰화: 표준에 맞춰 지정된 태그들을 토큰화함
3.  렉싱(lexical analysis): 토큰을 해당 속성 및 규칙을 정의하는 노드로 만듦
4.  트리 생성: root 노드를 기준으로 생성된 노드들의 계층을 연결

##### 1-1. html 파싱

렌더러 프로세스가 html 데이터를 수신하기 시작하면 렌더러 프로세스의 메인 스레드는 html을 파싱해 dom으로 변환하기 시작한다. 파싱의 최종 결과로 dom 트리가 만들어지며, dom 트리의 최상위 노드(root)는 html이다.
웹사이트는 일반적으로 이미지나 css, 자바스크립트와 같은 외부 리소스를 필요로 한다. 이런 파일들은 네트워크 혹은 캐시되어있는 데이터를 통해 가져와야 한다. dom트리를 파싱하는 과정에서 데이터를 가져올 수도 있지만 모던 브라우저는 속도를 높이기 위해 img나 link같은 태그가 있으면 미리 브라우저 프로세스의 네트워크 스레드로 요청을 보낸다.

script 태그의 경우 조금 다른데, 자바스크립트에는 문서 전체의 구조를 바꿀 수 있는 innerHTML이나 document.write() 등의 메서드나 프로퍼티가 존재하기 때문이다. 따라서 브라우저는 script가 있을 경우 이를 로딩하고 파싱하기 위해 html 파싱을 중단한다. 만약 script에서 문서 조작이 이뤄지지 않는다면 async나 defer 속성을 지정해 스크립크를 비동기적으로 로딩하고 실행할 수 있다.

##### 1-2. css 파싱

html 파싱 과정에서 link 태그를 만나면 해당 css 리소스를 가져온다. css도 html과 마찬가지로 토큰화, 노드 생성 과정을 거쳐 CSSOM이라는 트리 구조를 가진다. CSSOM은 자바스크립트에서 CSS를 조작할 수 있게 해주는 API 집합이다. CSSOM 트리의 노드는 DOM 요소의 선택자에 맞춰 적용될 CSS 스타일 정보가 포함되어 있다. link, title 등 화면에 나타나지 않는 요소들에 대한 DOM 요소는 포함되지 않는다. 또한 CSS는 부모의 스타일을 상속받는 경우가 존재하므로 CSSOM은 하향식으로 생성된다.

##### 1-3. 렌더트리 생성

렌더트리는 CSSOM트리와 DOM트리가 결합되어 생성된다. 각 노드는 렌더 객체로 이루어져 있으며 렌더 객체는 보이는 노드만을 포함한다. 렌더트리의 생성과정은 다음과 같다.
-html과 body 태그를 처리하여 렌더 트리 루트를 구성한다.
-DOM 트리를 순회하며 최상위 노드부터 보여지지 않는 노드를 생략한다.
-display:none 처럼 숨겨지는 노드 또한 생략한다.
-float나 position과 같은 속성을 사용한 경우 흐름에서 벗어나 실제 그려지는 위치로 렌더 객체가 이동한다. -화면에 나타나는 노드에 CSSOM 규칙을 찾아 일치하는 스타일을 적용한다.

#### 2. 레이아웃

레이아웃은 각 요소의 상대적인 위치와 크기를 찾는 과정이다. 렌더트리의 모든 노드들은 자식 노드들의 레이아웃을 호출하는 layout을 갖는다. 레이아웃은 렌더트리의 최상위 노드인 html부터 시작하며 이후 자식 렌더 객체들의 레이아웃을 배치하며 반복적으로 발생한다.
레이아웃은 흐름 기반의 배치 모델을 사용한다. 요소가 나타나는 순서대로 왼쪽에서 오른쪽, 위에서 아래의 방향으로 진행된다. 레이아웃이 이뤄지는 과정은 다음과 같다.

- 부모 노드가 자식 노드의 너비를 결정한다.
- 자식 렌더링 객체를 배치한다.
- 자식 렌더링 객체의 높이를 더해 부모 렌더 객체의 높이를 계산한다.
- 레이아웃 중인 렌더 객체의 더티 플래그를 제거한다. \*더티: 렌더 객체에서 다시 배치할 필요가 있는 변경 요소, 추가된 노드, 그리고 자식 노드를 더티라고 표시한다.

#### 3. 페인트

렌더 트리를 순회하며 레이어를 만들고 레이어의 배경, 테두리, 텍스트, 그려지는 순서, 레이어 간의 순서 등 그려지는 과정을 기록한다.

#### 4. 합성

합성 단계에서는 각 레이어를 분리해서 래스터화한 뒤 브라우저에서 페이지의 크기, 뷰포트에 맞게 합성으로 나타낸다. (\*래스터화: 이전 단계들에서 계산한 요소들의 순서, 스타일, 위치 등을 화면의 픽셀로 변환)
